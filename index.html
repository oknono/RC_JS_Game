<!DOCTYPE html>
<html>
<head>
<title>HTML 5 Game</title>
</head>
<body>
<canvas id ="ctx" width="500" height="500" style="border:1px solid #000000"> </canvas>
<script type="text/javascript">

var ctx = document.getElementById("ctx").getContext("2d");
ctx.font = '30px Arial';

var HEIGHT = 500;
var WIDTH = 500;
var timeWhenGameStarted = Date.now();
var framecount = 0;
var score = 0;
var player;
var enemyList = {};
var upgradeList = {};
var bulletList = {};

Entity = function(type, id, x, y , spdX, spdY, width, height, color){
    var self = {
        type:type,
        id:id,
        x:x,
        y:y,
        spdX:spdX,
        spdY:spdY,
        width:width,
        height:height,
        color:color,
        };

    self.update = function(){
        self.updatePosition();
        self.draw();
    }

    self.updatePosition = function(){
        self.x += self.spdX;
        self.y += self.spdY;
        if (self.x < 0  || self.x > WIDTH)
            self.spdX *= -1;
        if (self.y < 0 || self.y > HEIGHT)
            self.spdY *= -1;
        }    

    self.draw = function(){
        ctx.save();
        ctx.fillStyle = self.color;
        ctx.fillRect(self.x - self.width/2, self.y - self.height/2, self.width, self.height);
        ctx.restore();
        }

    self.getDistance = function(entity2){
        var dx = self.x - entity2.x;
        var dy = self.y - entity2.y;
        return Math.sqrt(dx*dx + dy*dy);
        } 

    self.testCollision = function(entity2){
        var entity1 = {
            x:self.x - self.width/2,
            y:self.y - self.height/2, 
            width: self.width,
            height:self.height,
        }
        var entity2 = {
                x:entity2.x - entity2.width/2,
                y:entity2.y - entity2.height/2, 
                width: entity2.width,
                height:entity2.height,
                }
        return testCollisionRectangles(entity1,entity2);
        }
    return self;
}

testCollisionRectangles = function (r1, r2){
    return r1.x <= r2.x + r2.width
        && r2.x <= r1.x + r1.width
        && r1.y <= r2.y + r2.height
        && r2.y <= r1.y + r1.height;
}

Actor = function(type, id, x , y, spdX, spdY, width, height, color, hp, attackSpeed){
    var self = Entity(type, id, x , y, spdX, spdY, width, height, color);

    self.hp = hp;
    self.attackSpeed = attackSpeed;
    self.attackCounter = 1;
    self.aimAngle = 0;

    var super_update = self.update;
    self.update = function() {
        super_update();
        self.attackCounter += self.attackSpeed;
    }

    self.performAttack = function(){
    if(self.attackCounter > 25){  // Every 1 second
        self.attackCounter = 0;
        generateBullet(self);
        }
    }

    self.performSpecialAttack = function(){
    if(self.attackCounter > 50){  // Every 2 second
        self.attackCounter = 0;
        generateBullet(self, self.aimAngle - 5);
        generateBullet(self, self.aimAngle);
        generateBullet(self, self.aimAngle + 5);        
        }
    }
    return self;
}

Player = function(){ 
    var self = Actor('player','MyID', 250, 250 , 30, 5, 20, 20, 'green', 10, 1);

    self.pressDown = false;
    self.pressUp = false;
    self.pressLeft = false;
    self.pressRight = false;

    self.updatePosition = function(){
        if(self.pressRight && self.x < WIDTH - self.width/2)
            self.x += 10;
        if(self.pressLeft && self.x > 0 + self.width/2)
            self.x -= 10;
        if(self.pressUp && self.y > 0 + self.height/2)
            self.y -= 10;
        if(self.pressDown && self.y < HEIGHT - self.height/2)
            self.y += 10;
            }

    var super_update = self.update;
    self.update = function(){
        super_update();
        if (self.hp <= 0){
            var timeSurvived = Date.now() - timeWhenGameStarted;
            console.log("You lost! You survived for " + timeSurvived + "ms");
            startNewGame();
            }
        }
    return self;
}

Enemy = function(id, x , y, spdX, spdY, width, height){
    var self = Actor('enemy', id, x, y , spdX, spdY, width, height, 'red', 10, 1);

    var super_update = self.update;
    self.update = function(){
        super_update();
        self.performAttack();
        var isColliding = player.testCollision(self)
        if (isColliding)
            player.hp -= 1;
    }

    enemyList[id] = self;
}

randomGenerateEnemy = function (){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var width = 10 + Math.random() * 30;
    var height =  10 + Math.random() * 30;
    var id = Math.random();
    var spdX = 5 + Math.random() * 5;
    var spdY = 5 + Math.random() * 5;
    Enemy(id, x, y, spdX, spdY, width, height);
}

Upgrade = function(id, x , y, spdX, spdY, width, height , color, category){
    var self = Entity('upgrade', id, x, y , spdX, spdY, width, height, color);
    self.category = category;
   
    var super_update = self.update;
    self.update = function(){
        var isColliding = player.testCollision(self)
            if (isColliding){
                if (self.category === 'score')
                    score += 1000;
                if (self.category === 'attack')
                    player.attackSpeed += 3;

                delete upgradeList[self.id]
            }
        }
    upgradeList[id] = self;
}

randomGenerateUpgrade = function (){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var width = 10;
    var height = 10; 
    var id = Math.random();
    var spdX = 0;
    var spdY = 0;

    if (Math.random() < 0.5){
        var category = 'score';
        var color = 'orange';
    }

    else {
        var category = 'attack';
        var color = 'blue';
    }
    Upgrade(id, x, y, spdX, spdY, width, height, color, category);
}

Bullet = function(id, x , y, angle, spdX, spdY, width, height, color, timer){
    var self = Entity('bullet', id, x, y , spdX, spdY, width, height, 'black');
    self.angle = angle;
    self.timer = timer;

    var super_update = self.update;
    self.update = function(){
        super_update();
        var toRemove = false;
        self.timer++;
        if (self.timer > 100){
            toRemove = true;
            }
        for(var key2 in enemyList){
            /*
            var isColliding = bulletList[key].testCollision(enemyList[key2]);
                if (isColliding){
                    toRemove = true;
                    delete enemyList[key2];
                    //after deleting bullet stop the loop
                    break;
               }
              */ 
           } 
        if (toRemove)
            delete bulletList[self.id];
        }
    bulletList[id] = self;
}

generateBullet = function (actor, overwriteAngle){
    var x = actor.x;
    var y = actor.y;
    var width = 10;
    var height = 10; 
    var id = Math.random();
    var angle = actor.aimAngle;
    if (overwriteAngle != undefined)
        angle = overwriteAngle;
    var spdX = Math.cos(angle/180*Math.PI)*5;
    var spdY = Math.sin(angle/180*Math.PI)*5;
    var color = 'black';
    var timer = 0;
   Bullet(id, x, y, angle, spdX, spdY, width, height, color, timer);
}

document.onmousemove = function(mouse){
    var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
    var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;
    mouseX -= player.x;
    mouseY -= player.y;
    player.aimAngle = Math.atan2(mouseY, mouseX) / Math.PI * 180;
}

document.onclick = function(mouse){
    player.performAttack();
}

document.oncontextmenu = function(mouse){  // on rightclick
    player.performSpecialAttack();   
    mouse.preventDefault();
}

document.onkeydown = function(event){
    if (event.keyCode == 68)
        player.pressRight = true;
    else if (event.keyCode == 83)
        player.pressDown = true;
    else if (event.keyCode == 65)
        player.pressLeft = true;
    else if (event.keyCode == 87)
        player.pressUp = true;
}

document.onkeyup = function(event){
    if (event.keyCode == 68)
        player.pressRight = false;
    else if (event.keyCode == 83)
        player.pressDown = false;
    else if (event.keyCode == 65)
        player.pressLeft = false;
    else if (event.keyCode == 87)
        player.pressUp = false;
}

update = function (){
	ctx.clearRect(0,0,WIDTH,HEIGHT);
    framecount++;
    score++;

    if(framecount % 100 == 0) // Every 4 seconds
        randomGenerateEnemy();
    if(framecount % 75 == 0) // Every 3 seconds 
        randomGenerateUpgrade();

    for(var key in bulletList){
        bulletList[key].update();
    }

    for(var key in upgradeList){
        upgradeList[key].update();
        }

    for(var key in enemyList){
        enemyList[key].update();
        }

	player.update();
    ctx.fillText("HP: " + player.hp, 0, 30);
    ctx.fillText("score: " + score , 200, 30);
}

startNewGame = function(){
    timeWhenGameStarted = Date.now();
    framecount = 0;
    score = 0;
    player.hp = 10;
    enemyList = {};
    upgradeList = {};
    bulletList = {};
    randomGenerateEnemy();
    randomGenerateEnemy();
    randomGenerateEnemy();
}

player = Player();
startNewGame();
setInterval(update, 40);


</script>
</body>
</html>