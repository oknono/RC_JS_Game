<!DOCTYPE html>
<html>
<head>
<title>HTML 5 Game</title>
</head>
<body>
<canvas id ="ctx" width="500" height="500" style="border:1px solid #000000"> </canvas>
<script type="text/javascript">
var ctx = document.getElementById("ctx").getContext("2d");
ctx.font = '30px Arial';

var HEIGHT = 500;
var WIDTH = 500;
var timeWhenGameStarted = Date.now();
var framecount = 0;
var score = 0;
var player;

//player
createPlayer = function(){ 
    player = {
        type:'player',
        x:100,
        spdX:25,
        y:350,
        spdY:10,
        name:'p',
        hp:10,
        height:20,
        width:20,
        color:'green',
        attackSpeed:1,
        attackCounter:1,
        pressDown: false,
        pressUp: false,
        pressLeft: false,
        pressRight: false,
        aimAngle:0,
    }
}
//enemy

Enemy = function(id, x , y, spdX, spdY, h, w , color){
    //local variable
    var enemy = {
    type:'enemy',    
    x:x,
    spdX:spdX,
    y:y,
    spdY:spdY,
    id:id,
    name:'E',
    height:h,
    width:w,
    color:color,
    aimAngle:0,
    attackSpeed:1,
    attackCounter:1,
   };

// link to permanent variable
enemyList[id] = enemy;
}

Upgrade = function(id, x , y, spdX, spdY, h, w , color, category){
    //local variable
    var upgrade = {
    type:'upgrade',    
    x:x,
    spdX:spdX,
    y:y,
    spdY:spdY,
    id:id,
    name:'U',
    height:h,
    width:w,
    color:color,
    category:category,
   };

// link to permanent variable
upgradeList[id] = upgrade;

}

Bullet = function(id, x , y, angle, spdX, spdY, h, w, color, timer){
    //local variable
    var bullet = {
    type: 'bullet',    
    x:x,
    spdX:spdX,
    y:y,
    spdY:spdY,
    angle:angle,
    id:id,
    name:'U',
    height:h,
    width:w,
    color:color,
    timer:timer,
   };

// link to permanent variable
bulletList[id] = bullet;
}

var enemyList = {};
var upgradeList = {};
var bulletList = {};

document.onmousemove = function(mouse){
    var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
    var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

    mouseX -= player.x;
    mouseY -= player.y;

    player.aimAngle = Math.atan2(mouseY, mouseX) / Math.PI * 180;
}

document.onclick = function(mouse){
    performAttack(player);
}

document.oncontextmenu = function(mouse){  // on rightclick
    performSpecialAttack(player);   
    mouse.preventDefault();
}

performAttack = function(actor){
    if(actor.attackCounter > 25){  // Every 1 second
        actor.attackCounter = 0;
        generateBullet(actor);
    }
}

performSpecialAttack = function(actor){
    if(actor.attackCounter > 50){  // Every 1 second
        /*var angle = 0;
        for(var angle=0; angle < 360; angle++){
             generateBullet(player, angle); 
        }*/
        actor.attackCounter = 0;
        generateBullet(actor, actor.aimAngle - 5);
        generateBullet(actor, actor.aimAngle);
        generateBullet(actor, actor.aimAngle + 5);        
    }
}

document.onkeydown = function(event){
    //use awsd to move around
    if (event.keyCode == 68)
        player.pressRight = true;
    else if (event.keyCode == 83)
        player.pressDown = true;
    else if (event.keyCode == 65)
        player.pressLeft = true;
    else if (event.keyCode == 87)
        player.pressUp = true;
}

document.onkeyup = function(event){
    //use awsd to move around
    if (event.keyCode == 68)
        player.pressRight = false;
    else if (event.keyCode == 83)
        player.pressDown = false;
    else if (event.keyCode == 65)
        player.pressLeft = false;
    else if (event.keyCode == 87)
        player.pressUp = false;
}

getDistanceBetweenEntities = function (e1, e2){
    var dx = e1.x - e2.x;
    var dy = e1.x - e2.x;
    return Math.sqrt(dx*dx + dy*dy);
}

testCollisionEntities = function (e1, e2){
    var e1 = {
        x:e1.x - 10,
        y:e1.y - 10, 
        width: e1.width,
        height:e1.height,
    }
    var e2 = {
        x:e2.x -15,
        y:e2.y -15, 
        width: e2.width,
        height: e2.height,
    }
    return testCollisionRectangles(e1,e2);
} 

testCollisionRectangles = function (r1, r2){
    return r1.x <= r2.x + r2.width
        && r2.x <= r1.x + r1.width
        && r1.y <= r2.y + r2.height
        && r2.y <= r1.y + r1.height;
}

updateEntity = function(entity){
    updateEntityPosition(entity);
    drawEntity(entity);
}


updateEntityPosition = function(entity){
    if (entity.type === 'player'){
        if(entity.pressRight && player.x < WIDTH - entity.width/2)
            entity.x += 10;
        if(entity.pressLeft && entity.x > 0 + entity.width/2)
            entity.x -= 10;
        if(entity.pressUp && entity.y > 0 + entity.height/2)
            entity.y -= 10;
        if(entity.pressDown && entity.y < HEIGHT - entity.height/2)
            entity.y += 10;
        }
    else {
        entity.x += entity.spdX;
        entity.y += entity.spdY;
        if  (entity.type === 'bullet'){
            if (entity.x < 0  || entity.x > WIDTH || entity.y < 0 || entity.y > HEIGHT)
                delete entity;}
        else {
            if (entity.x < 0  || entity.x > WIDTH)
                entity.spdX *= -1;
            if (entity.y < 0 || entity.y > HEIGHT)
                entity.spdY *= -1;
              }    
        }
}

drawEntity = function(entity){
    ctx.save();
    ctx.fillStyle = entity.color;
    ctx.fillRect(entity.x - entity.width/2, entity.y - entity.height/2, entity.width, entity.height);
    ctx.restore();
    }

update = function (){
	ctx.clearRect(0,0,WIDTH,HEIGHT);
    framecount++;
    score++;

    if(framecount % 100 == 0){ // Every 4 seconds
        randomGenerateEnemy();
    }

    if(framecount % 75 == 0){  // Every 3 seconds 
        randomGenerateUpgrade();
    }
    
    player.attackCounter += player.attackSpeed;

    for(var key in bulletList){
        updateEntity(bulletList[key]);
        
        var toRemove = false;
        bulletList[key].timer++;
        if (bulletList[key].timer > 100){
            toRemove = true;
        }

        for(var key2 in enemyList){
            var isColliding = testCollisionEntities(bulletList[key], enemyList[key2]);
                if (isColliding){
                    toRemove = true;
                    delete enemyList[key2];
                    //after deleting bullet stop the loop
                    break;
               }
           }
        if (toRemove){
            delete bulletList[key];
        }
      }

    for(var key in upgradeList){
        updateEntity(upgradeList[key]);

        var isColliding = testCollisionEntities(player, upgradeList[key])
        if (isColliding){
            if (upgradeList[key].category === 'score'){
                score += 1000;
            }
            if (upgradeList[key].category === 'attack'){
                player.attackSpeed += 3;
            }

            delete upgradeList[key]
        }
    }

    for(var key in enemyList){
        updateEntity(enemyList[key]);

        var isColliding = testCollisionEntities(player, enemyList[key])
        if (isColliding){
            player.hp -= 1;
        }

        if (player.hp <= 0){
                var timeSurvived = Date.now() - timeWhenGameStarted;
                console.log("You lost! You survived for " + timeSurvived + "ms");
                startNewGame();
            }
	}
	updateEntity(player);
    ctx.fillText("HP: " + player.hp, 0, 30);
    ctx.fillText("score: " + score , 200, 30);
}

startNewGame = function(){
    player.hp = 10;
    timeWhenGameStarted = Date.now();
    framecount = 0;
    score = 0;
    enemyList = {};
    upgradeList = {};
    bulletList = {};
    randomGenerateEnemy();
    randomGenerateEnemy();
    randomGenerateEnemy();
}


randomGenerateEnemy = function (){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var width = 10 + Math.random() * 30;
    var height =  10 + Math.random() * 30;
    var id = Math.random();
    var spdX = 5 + Math.random() * 5;
    var spdY = 5 + Math.random() * 5;
    var color = 'red';

    Enemy(id, x, y, spdX, spdY, height, width,  color);
}

randomGenerateUpgrade = function (){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var width = 10;
    var height = 10; 
    var id = Math.random();
    var spdX = 0;
    var spdY = 0;

    if (Math.random() < 0.5){
        var category = 'score';
        var color = 'orange';
    }

    else{
        var category = 'attack';
        var color = 'blue';
    }
    

   Upgrade(id, x, y, spdX, spdY, height, width, color, category);
}

 generateBullet = function (actor, overwriteAngle){
    var x = actor.x;
    var y = actor.y;
    var width = 10;
    var height = 10; 
    var id = Math.random();
    var angle = actor.aimAngle;
    if (overwriteAngle != undefined){
        angle = overwriteAngle;
    }
    var spdX = Math.cos(angle/180*Math.PI)*5;
    var spdY = Math.sin(angle/180*Math.PI)*5;
    var color = 'black';
    var timer = 0;

   Bullet(id, x, y, angle, spdX, spdY, height, width, color, timer);
}

createPlayer();
startNewGame();
setInterval(update, 40);


</script>
</body>
</html>